resources:
- name: {{properties["name"]}}
  type: compute.v1.instance
  properties:
    zone: {{properties["zone"]}}
    machineType: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/zones/{{properties["zone"]}}/machineTypes/g1-small
    tags:
      items: [{{properties["tags"]}}]
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      initializeParams:
        sourceImage: https://www.googleapis.com/compute/v1/projects/ubuntu-os-cloud/global/images/ubuntu-1804-bionic-v20190617
    networkInterfaces:
    - network: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/networks/{{properties["network"]}}
      subnetwork: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/regions/{{properties["region"]}}/subnetworks/{{properties["subnet"]}}
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
    metadata:
      items:
        - key: startup-script
          value: |
            {{ imports["scripts/install_ansible.py"]|indent(12)|replace("@PROJECT@",env["project"])|replace("@ZONE@",properties["zone"]) }}
{# 
Create service account.
#}
- name: {{ env['name'] }}
  type: iam.v1.serviceAccount
  properties:
    accountId: {{ env['name'] }}-svc-account
    displayName: serviceAccount-{{ env['name'] }}-svc-account
{# 
Update rights to give the account project owner privileges.
Found this snippet on StackOverflow here:
https://stackoverflow.com/questions/48710548/google-deployment-manager-assigning-iam-policies-at-project/49416120#answer-49416120
#}
- name: get-iam-policy
  action: gcp-types/cloudresourcemanager-v1:cloudresourcemanager.projects.getIamPolicy
  properties:
    resource: {{ env["project"] }}
  metadata:
    runtimePolicy:
    - 'UPDATE_ALWAYS'

- name: update-iam-policy
  action: gcp-types/cloudresourcemanager-v1:cloudresourcemanager.projects.setIamPolicy
  properties:
    resource: {{ env["project"] }}
    policy: $(ref.get-iam-policy)
    gcpIamPolicyPatch:
      add:
      - role: roles/owner
        members:
        - serviceAccount:$(ref.{{ deployment }}-svc-account.email)
